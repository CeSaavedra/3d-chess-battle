<!--Luke Pressimone-->
<!--Account Template for 3D Chess Profile-->
<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Account Template</title>
    <link rel="stylesheet" href="../css/accountTemplateStyle.css">
    <meta charset="utf-8">
  </head>
  <body>
    <div id="content-container">
      <div id="navbar-container">
        <h1>â™Ÿ</h1>
      </div>
      <div id="main-container">
        <h1><span id="username-display">testUser</span></h1>
        <img src="../assets/profile-pictures/profilePic.png" alt="Profile Picture" width="200" height="200">
        <h3><i>Account Details:</i></h3>
        <div id="prompt-container">
          <ul>
            <li>Username: <span id="username-detail">testUser</span></li>
            <li>Wins: <span id="wins">testWins</span></li>
            <li>Losses: <span id="loses">testLosses</span></li>
            <li>Win Rate: <span id="winRate">testWR</span></li>
            <li>
              <button id="change-username-btn" type="button">
                Change Username
              </button>
            </li>
          </ul>
          <!--Multiplayer stuff goes here-->
        </div>
      </div>
    </div>

    <script>
      const INSTANCE_IP = '3.237.184.159';
      const BASE = `http://${INSTANCE_IP}:3000`;
      const DB_HEALTH_URL = `${BASE}/db-health`;
      const USER_BY_NAME_URL = username => `${BASE}/users/${encodeURIComponent(username)}`;
      const USER_BY_ID_URL = userId => `${BASE}/users/id/${encodeURIComponent(userId)}`;
      const RENAME_BY_ID_URL = userId => `${BASE}/users/id/${encodeURIComponent(userId)}/rename`;
      const TIMEOUT_MS = 5000;

      // TEMP: until you hook in real auth/session
      const DEFAULT_USER_ID = '2cb040d5-cd49-11f0-b8d3-022f637f4249';
      const DEFAULT_USERNAME = 'bob';
      const CURRENT_USER_ID = DEFAULT_USER_ID;

      async function fetchWithTimeout(url, options = {}) {
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), TIMEOUT_MS);
        try {
          const res = await fetch(url, { signal: controller.signal, ...options });
          clearTimeout(timeout);
          const text = await res.text();
          let json = null;
          try {
            json = JSON.parse(text);
          } catch (e) {
            // not JSON, leave json as null
          }
          return { ok: res.ok, status: res.status, json, raw: text };
        } catch (err) {
          clearTimeout(timeout);
          return { ok: false, error: err.name === 'AbortError' ? 'timeout' : err.message };
        }
      }

      async function loadUserAndUpdateUI() {
        const usernameHeader = document.getElementById('username-display');
        const usernameDetail = document.getElementById('username-detail');
        const winsSpan = document.getElementById('wins');
        const lossesSpan = document.getElementById('loses'); // original id="loses"
        const winRateSpan = document.getElementById('winRate');

        // Prefer lookup by ID; fallback to username
        let userRes = await fetchWithTimeout(USER_BY_ID_URL(CURRENT_USER_ID));
        if (!(userRes.ok && userRes.json && userRes.json.ok && userRes.json.user)) {
          userRes = await fetchWithTimeout(USER_BY_NAME_URL(DEFAULT_USERNAME));
        }
        if (!(userRes.ok && userRes.json && userRes.json.ok && userRes.json.user)) {
          console.error('Failed to load user:', userRes);
          return;
        }

        const user = userRes.json.user;
        const username = user.username || 'unknown';
        const wins = Number(user.winNum || 0);
        const losses = Number(user.lossNum || 0);

        // Update username in both places
        if (usernameHeader) usernameHeader.textContent = username;
        if (usernameDetail) usernameDetail.textContent = username;

        // Update wins + losses
        if (winsSpan) winsSpan.textContent = wins;
        if (lossesSpan) lossesSpan.textContent = losses;

        // Compute win rate
        const totalGames = wins + losses;
        let winRateText = 'N/A';
        if (totalGames > 0) {
          const rate = (wins / totalGames) * 100;
          winRateText = rate.toFixed(1) + '%';
        }
        if (winRateSpan) winRateSpan.textContent = winRateText;
      }

      async function handleChangeUsernameClick() {
        const button = document.getElementById('change-username-btn');
        if (!button) return;

        const newUsernameRaw = prompt('Enter a new username:');
        if (newUsernameRaw === null) {
          // User hit Cancel
          return;
        }

        const newUsername = newUsernameRaw.trim();
        if (!newUsername) {
          alert('Username cannot be empty.');
          return;
        }

        // basic length check
        if (newUsername.length > 32) {
          alert('Username is too long (max 32 characters).');
          return;
        }

        button.disabled = true;
        button.textContent = 'Changing...';

        try {
          const renameRes = await fetchWithTimeout(RENAME_BY_ID_URL(CURRENT_USER_ID), {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            body: JSON.stringify({ newUsername })
          });

          if (renameRes.ok && renameRes.json && renameRes.json.ok) {
            alert('Username updated successfully!');
            // Re-fetch user info to refresh UI
            await loadUserAndUpdateUI();
          } else {
            const msg =
              (renameRes.json && (renameRes.json.error || renameRes.json.message)) ||
              renameRes.error ||
              'Unknown error occurred.';
            alert('Failed to update username: ' + msg);
            console.error('Rename error:', renameRes);
          }
        } catch (err) {
          console.error('Rename exception:', err);
          alert('An error occurred while updating username.');
        } finally {
          button.disabled = false;
          button.textContent = 'Change Username';
        }
      }

      document.addEventListener('DOMContentLoaded', async () => {
        // Initial load
        await loadUserAndUpdateUI();

        // Wire up Change Username button
        const changeBtn = document.getElementById('change-username-btn');
        if (changeBtn) {
          changeBtn.addEventListener('click', handleChangeUsernameClick);
        }
      });
    </script>
  </body>
</html>